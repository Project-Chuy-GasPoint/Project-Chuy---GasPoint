<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Chuy: GasPoint</title>

<!-- Custom CSS -->
<link rel="stylesheet" href="style.css">

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
</head>
<body>

<header class="main-header">
  <div class="logo">
    <img src="images\logo-gaspoint.png" alt="Logo" style="height:40px; width:auto; margin-right:10px;">
    Project Chuy: GasPoint
  </div>
  <nav class="nav-links">
    <button onclick="goHome()">Home</button>
    <button onclick="goShops()">Shops</button>
  </nav>
</header>

<div class="container-fluid mt-3">
  <div class="row">

  <!-- Sidebar -->
    <div class="col-md-3">

  <!-- Weather card -->
  <div class="weather-box mb-3">
    <div class="card">
      <div class="card-header text-white">Current Weather</div>
      <div class="card-body">
        <button class="btn w-100 mb-2" onclick="getWeather()">Check Weather</button>
        <div id="weatherResult" style="font-size: 14px;"></div>
      </div>
    </div>
  </div>

  <!-- LPG Shops List -->
  <div class="card mb-3">
    <div class="card-header bg-primary text-white">LPG Shops</div>
    <ul class="list-group list-group-flush shop-list" id="shopList"></ul>
  </div>

</div>

    <div class="col-md-9">

    <!-- Search bar -->
  <div class="search-box mb-3">
    <input id="locationSearch" placeholder="Enter barangay">
    <button onclick="searchLocation()">Search</button>
  </div>

      <div id="map"></div>
    </div>
</div>
<script>

const street = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { attribution: "&copy; OpenStreetMap contributors" });
const satellite = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Tiles © Esri" });

const map = L.map("map", { center:[8.3646,124.8651], zoom:13, layers:[street] });
L.control.layers({ "OpenStreetMap":street, "Satellite":satellite }, null, { collapsed:false }).addTo(map);

let gasStores = [];
let markers = [];

fetch("gaspoint-data.json")
.then(r => r.json())
.then(data => {
    gasStores = data;
    placeMarkers();
    loadShops();
});

  function placeMarkers(){
    gasStores.forEach(store => {
        let popupHtml = `<b>${store.title}</b><br>${store.description}`;
        if(store.contact) popupHtml += `<br><b>Contact:</b> ${store.contact}`;
        if(store.image) popupHtml += `<br><img src="${store.image}" width="150">`;

        const redIcon = L.icon
        ({ iconUrl:"images/red lpg.png", iconSize:[40,40], iconAnchor:[20,40], popupAnchor:[0,-40] });
        const blueIcon = L.icon
        ({ iconUrl:"images/blue lpg.png", iconSize:[40,40], iconAnchor:[20,40], popupAnchor:[0,-40] });

        let useIcon = redIcon;
        let title = store.title.toLowerCase();
        if(title.includes("phoenix")
         || title.includes("gd lpg")
         || title.includes("kris")
         || title.includes("apex" )
         || title.includes("petron")){
            useIcon = blueIcon;
        }

        const marker = L.marker([store.lat, store.lng], { icon:useIcon }).bindPopup(popupHtml);
        marker.type = (useIcon===blueIcon)?"blue":"red";
        marker.addTo(map);
        markers.push(marker);
    });
}

function loadShops(){
    const list = document.getElementById('shopList');
    list.innerHTML = '';
    gasStores.forEach(store=>{
        const item = document.createElement('li');
        item.className = 'list-group-item shop-item';
        item.textContent = store.title;

        item.onclick = ()=>{
            map.setView([store.lat, store.lng],16);
            const marker = markers.find(m=>m.getLatLng().lat===store.lat && m.getLatLng().lng===store.lng);
            if(marker) marker.openPopup();
        }

        list.appendChild(item);
    });
}

// Filter checkboxes
const filterControl = L.control({ position:'topright' });
filterControl.onAdd = function(map){
    const div = L.DomUtil.create('div','filter-box');
    div.innerHTML = `
        <label><input type="checkbox" id="showBlue" checked> Blue LPG</label><br>
        <label><input type="checkbox" id="showRed" checked> Red LPG</label>
    `;

    L.DomEvent.disableClickPropagation(div);

    div.querySelector('#showBlue').addEventListener('change', updateMarkers);
    div.querySelector('#showRed').addEventListener('change', updateMarkers);
    return div;
};

filterControl.addTo(map);

function updateMarkers(){
    const showBlue = document.getElementById("showBlue").checked;
    const showRed = document.getElementById("showRed").checked;
    markers.forEach(marker=>{
        const onMap = map.hasLayer(marker);
        if((marker.type==="blue" && showBlue)||(marker.type==="red" && showRed)){
            if(!onMap) marker.addTo(map);
        } else {
            if(onMap) map.removeLayer(marker);
        }
    });
}

// Search locations
const knownLocations = {
    "damilag":[8.3503,124.8121],
    "alae":[8.4208119,124.8133793],
    "manolo":[8.3646,124.8651],
    "agusan":[8.3263,124.8086],
    "lunocan":[8.4143,124.8231],
    "san miguel":[8.3890,124.8332]
};

function searchLocation(){
    const q = document.getElementById("locationSearch").value.toLowerCase();
    if(!knownLocations[q]) return;
    map.setView(knownLocations[q],15);
}

function goHome(){ window.scrollTo({top:0, behavior:'smooth'});}
function goShops(){ document.getElementById('shopList').scrollIntoView({behavior:'smooth'});}

const apiKey = "931a7542b975d1d2e15946ee8e9b97cf";

async function getWeather() {
    console.log("Prompt opened. " + Date());
    const city = prompt("Enter a city name:");
    console.log("Prompt closed. " + Date());

    if (!city) {
        alert("No city entered.");
        console.log("No city entered. " + Date());
        return;

}
const url = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error("City not found");

        const data = await response.json();

        const weatherResult = document.getElementById("weatherResult");
        weatherResult.innerHTML = `
            <h5>${data.name}, ${data.sys.country}</h5>
            <p><b>Temperature:</b> ${data.main.temp}°C</p>
            <p><b>Weather:</b> ${data.weather[0].description}</p>
            <p><b>Humidity:</b> ${data.main.humidity}%</p>
            <p><b>Wind Speed:</b> ${data.wind.speed} m/s</p>
        `;
        } catch (error) {
        alert("Error: " + error.message);
        console.log("Error: " + error.message);
    }
}

</script>

</body>
</html>
